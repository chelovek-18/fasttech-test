(()=>{"use strict";const t=t=>t.length>30?t.substr(0,30)+"...":t;class e{constructor(t){this.elem=t,this.init()}init(){this.elem[0].self=this,this.on()}}const i={fileInput:class extends e{constructor(t){super(t)}on(){const t=this,{tmpl:e,type:i}=this.elem.data(),s=$("input",this.elem),n=$("label",this.elem);n.attr("title","Выбрать файл"+("single"==i?"":"ы")),n.on("dragover",!1).on("drop",(function(e){e.preventDefault(),e.stopPropagation();let n=e.originalEvent.dataTransfer.files;s[0].files=n,"single"==i&&n.length>1&&(n=[n[0]]),t.change(n)})),s.change((function(){t.change(this.files)})),"single"!=i&&s.attr("multiple","multiple")}change(t){const{type:e}=this.elem.data();t=[{name:Object.keys(t).map((e=>t[e].name)).join("; ")}],$(`.files-ul[data-type=${e}]`).list=[].concat($(`.files-ul[data-type=${e}]`).list,t),$(`.files-ul[data-type=${e}]`).save()}},filesUl:class extends e{constructor(t){super(t)}save(){$("#file-form").submit()}delete(t){const{type:e}=this.elem.data();$.ajax({url:"delete",type:"POST",data:{type:e,file:t},success:function(t){$(`.files-ul[data-type=${e}]`).list=[].concat(t[e]||[])}})}render(){this.elem.html(`\n        <li class="no-files${this.list.length?"-pas":""}">Файлы отсутствуют</li>\n        ${this.list.map((e=>`<li class="li-file">\n            <div class="li-file-name">\n                ${e.state?`<a title="${e.name}" href="${document.location.origin+"/uploads/"+e.name}" class="file-link">${t(e.name)}</a>`:`<span title="${e.name}" class="file-link">${t(e.name)}</span>`}\n                <div class="preload-line"><div class="preload-val"></div></div>\n            </div>\n            <div class="li-file-btn">\n                ${e.state?'<i onclick="$( this ).delete();" class="fa fa-close fa-2x"></i>':'<i class="fa fa-spinner fa-spin fa-2x"></i>'}\n            </div>\n        </li>`)).join("")}\n        `)}on(){this.list=[],this.elem.list=[]}}};$(document).ready((function(){$("#file-form").length&&(function(t){$.fn.handler=function(){const e=this.data("tmpl").split("-").map(((t,e)=>e?t[0].toUpperCase()+t.substr(1):t)).join("");this.each((function(){new t[e]($(this))}))},Object.defineProperty($.fn,"ext",{get:function(){return this[0].self}}),Object.defineProperty($.fn,"list",{get:function(){let t=this[0]?[]:null;return 1==this.length?t=this.ext.list:this.length>1&&this.each((function(){t.push($(this).ext.list)})),t},set:function(t){this[0]&&this.each((function(){$(this).ext.list=t,$(this).ext.render()}))}}),$.fn.save=function(){this.each((function(){$(this).ext.save()}))},$.fn.delete=function(){this.each((function(){const t=$(this).closest(".li-file").find(".file-link").attr("title");$(this).closest(".files-ul").ext.delete(t)}))},$.ajaxSetup({url:"upload",type:"POST",dataType:"json",beforeSend:function(){console.log("улетело")},error:function(t){console.log("ошибка",t)},complete:function(){console.log("прилетело")}}),$("#file-form").on("submit",(function(t){t.preventDefault();let e=$(this),i=new FormData(e.get(0));$.ajax({contentType:!1,processData:!1,data:i,xhr:function(){let t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",(function(t){if(t.lengthComputable){var e=t.loaded/t.total;$(".fa-spinner").closest(".li-file").find(".preload-val").css("width",100*e+"%"),console.log("%",100*e)}}),!1),t},success:function(t){$(".files-ul[data-type=single]").list=[].concat(t.single||[]),$(".files-ul[data-type=multi]").list=t.multi||[],$("[type=file]").val("")}})}))}(i),$(".files-ul").handler(),$(".file-input").handler(),Object.keys(window.fileList||{}).forEach((t=>$(`.files-ul[data-type=${t}]`).list=JSON.parse(window.fileList[t]))))}))})();